# استيراد العملاء - Customer Import Documentation

## نظرة عامة - Overview

تم تطبيق خاصية استيراد العملاء من ملفات CSV باستخدام Filament Import Action. هذه الخاصية تسمح بـ:
- استيراد عملاء جدد بشكل جماعي
- تحديث بيانات العملاء الموجودين (بناءً على رقم الهاتف)
- التحقق من صحة البيانات قبل الاستيراد
- معالجة الاستيراد في الخلفية باستخدام Queue Jobs
- تنزيل ملف مثال CSV
- تنزيل تقرير بالصفوف الفاشلة

## الإعدادات المطلوبة - Setup Requirements

### 1. قاعدة البيانات - Database Migrations

تأكد من تشغيل جميع الـ Migrations المطلوبة:

```bash
php artisan migrate
```

الجداول المطلوبة:
- `job_batches` - لمعالجة المهام في الخلفية
- `notifications` - لإشعارات العملية
- `imports` - لتخزين بيانات عمليات الاستيراد
- `failed_import_rows` - لتخزين الصفوف الفاشلة

### 2. إعداد Queue - Queue Configuration

في ملف `.env`:

```env
QUEUE_CONNECTION=database
```

تشغيل Queue Worker:

```bash
php artisan queue:work
```

أو للتطوير:

```bash
php artisan queue:work --tries=3
```

## استخدام الخاصية - How to Use

### 1. الوصول للخاصية - Accessing Import

1. افتح صفحة العملاء من لوحة التحكم
2. انقر على زر "استيراد عملاء" في أعلى الجدول
3. ستظهر نافذة الاستيراد

### 2. تنسيق ملف CSV - CSV Format

#### الأعمدة المطلوبة - Required Columns:
- `name` (اسم العميل) - إجباري
- `phone` (رقم الهاتف) - إجباري وفريد

#### الأعمدة الاختيارية - Optional Columns:
- `has_whatsapp` (لديه واتساب) - true/false, 1/0, نعم/لا
- `address` (العنوان)
- `region` (المنطقة)
- `delivery_cost` (تكلفة التوصيل) - رقم عشري

#### مثال على ملف CSV:

```csv
name,phone,has_whatsapp,address,region,delivery_cost
أحمد محمد,01234567890,نعم,"شارع الجامعة، المعادي، القاهرة",المعادي,15.00
محمد علي,01098765432,لا,"شارع النصر، مدينة نصر",مدينة نصر,20.00
فاطمة حسن,01155443322,true,"شارع التحرير، الدقي",الدقي,18.00
```

### 3. خطوات الاستيراد - Import Steps

1. **تحميل الملف:**
   - انقر على "Browse" أو اسحب الملف
   - الملف يجب أن يكون بصيغة CSV

2. **مطابقة الأعمدة:**
   - سيحاول النظام تلقائياً مطابقة أعمدة ملفك مع حقول قاعدة البيانات
   - راجع المطابقات وصححها إذا لزم الأمر

3. **بدء الاستيراد:**
   - انقر على "استيراد"
   - ستتم معالجة الملف في الخلفية

4. **متابعة التقدم:**
   - ستصلك إشعارات بتقدم العملية
   - يمكنك متابعة الصفحة أثناء المعالجة

5. **مراجعة النتائج:**
   - بعد الانتهاء، ستظهر إشعار بعدد الصفوف الناجحة والفاشلة
   - يمكنك تنزيل ملف CSV بالصفوف الفاشلة لمراجعتها

## الميزات المتقدمة - Advanced Features

### 1. تحديث العملاء الموجودين

- إذا كان رقم الهاتف موجود في قاعدة البيانات، سيتم تحديث بيانات العميل
- إذا كان رقم الهاتف جديد، سيتم إنشاء عميل جديد

### 2. التحقق من الصحة - Validation

- **اسم العميل:** إجباري، حد أقصى 255 حرف
- **رقم الهاتف:** إجباري، حد أقصى 20 حرف، فريد
- **واتساب:** يجب أن يكون true/false أو 1/0 أو نعم/لا
- **العنوان:** حد أقصى 500 حرف
- **المنطقة:** حد أقصى 255 حرف
- **تكلفة التوصيل:** رقم، يجب أن يكون >= 0

### 3. الإعدادات الافتراضية

- **الحد الأقصى للصفوف:** 10,000 صف في الملف الواحد
- **حجم المعالجة:** 100 صف في كل دفعة
- **فاصل CSV:** الفاصلة `,`

## استكشاف الأخطاء - Troubleshooting

### المشكلة: لا يتم معالجة الاستيراد

**الحل:**
```bash
# تأكد من تشغيل Queue Worker
php artisan queue:work
```

### المشكلة: فشل جميع الصفوف

**الحلول المحتملة:**
1. تحقق من تنسيق ملف CSV (UTF-8 encoding)
2. تأكد من وجود الأعمدة المطلوبة
3. راجع الأخطاء في ملف الصفوف الفاشلة

### المشكلة: خطأ في رقم الهاتف المكرر

**الحل:**
- تأكد من عدم تكرار أرقام الهاتف في ملف CSV
- أو احذف العملاء المكررين من قاعدة البيانات أولاً

## الملفات المرتبطة - Related Files

- **Importer Class:** `app/Filament/Imports/CustomerImporter.php`
- **Resource:** `app/Filament/Resources/CustomerResource.php`
- **Model:** `app/Models/Customer.php`
- **Migrations:**
  - `database/migrations/2025_08_01_181541_create_imports_table.php`
  - `database/migrations/2025_08_01_181543_create_failed_import_rows_table.php`
  - `database/migrations/0001_01_01_000002_create_jobs_table.php` (job_batches)
  - `database/migrations/2025_08_01_181532_create_notifications_table.php`

## معلومات إضافية - Additional Information

### التخصيص

يمكنك تخصيص عملية الاستيراد من خلال:

1. **تعديل حد الأقصى للصفوف:**
```php
Tables\Actions\ImportAction::make()
    ->maxRows(50000) // بدلاً من 10000
```

2. **تعديل حجم المعالجة:**
```php
Tables\Actions\ImportAction::make()
    ->chunkSize(250) // بدلاً من 100
```

3. **تعديل الفاصل:**
```php
Tables\Actions\ImportAction::make()
    ->csvDelimiter(';') // بدلاً من ','
```

### الأداء

- معالجة 10,000 عميل تستغرق تقريباً 2-5 دقائق (حسب مواصفات السيرفر)
- يتم معالجة 100 صف في كل دفعة للحفاظ على استقرار الذاكرة
- يتم إعادة المحاولة تلقائياً في حالة فشل الـ Job (حتى 24 ساعة)

## الأمان - Security

- فقط المستخدمون المصرح لهم يمكنهم الوصول لصفحة الاستيراد
- يتم التحقق من صحة جميع البيانات قبل الإدخال
- أرقام الهاتف فريدة لمنع التكرار
- يتم تسجيل جميع عمليات الاستيراد للمراجعة
